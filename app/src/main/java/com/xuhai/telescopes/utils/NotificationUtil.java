package com.xuhai.telescopes.utils;

import android.annotation.TargetApi;
import android.app.Activity;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.os.Build;
import android.os.SystemClock;
import android.support.v4.app.NotificationCompat;
import android.widget.RemoteViews;

import com.xuhai.telescopes.service.DeleteService;


/**
 * @author LHB
 * @date 2015/11/29 0029.
 */
public class NotificationUtil {

    private static int NOTIFICATION_ID;
    private NotificationManager nm;
    private Notification notification;
    private NotificationCompat.Builder cBuilder;
    private Notification.Builder nBuilder;
    private Context mContext;
    int requestCode = (int) SystemClock.uptimeMillis();
    public static final int FLAG = PendingIntent.FLAG_ONE_SHOT;

    public NotificationUtil(Context context, int ID) {
        this.NOTIFICATION_ID = ID;
        mContext = context;
        // ????????????????????
        nm = (NotificationManager) mContext
                .getSystemService(Activity.NOTIFICATION_SERVICE);
        cBuilder = new NotificationCompat.Builder(mContext);
    }

    /**
     * ??????????????е???????
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     */
    private void setCompatBuilder(Intent intent, int smallIcon, String ticker,
                                  String title, String msg) {
        // ??????Activity??????????????????Activity??
        intent.setFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);
        // ??????????PendingIntent.FLAG_UPDATE_CURRENT?????????????????????????Ч???????????notification???????????????requestCode
        // ??Intent?????PendingIntent?У???????????????????????????
        PendingIntent pIntent = PendingIntent.getActivity(mContext,
                requestCode, intent, FLAG);

        cBuilder.setContentIntent(pIntent);// ???????????Intent

        cBuilder.setSmallIcon(smallIcon);// ?????????????С???
        cBuilder.setTicker(ticker);// ??????????е???????

        if(title != null){
            cBuilder.setContentTitle(title);// ??????????????
        }
        if (msg != null){
            cBuilder.setContentText(msg);// ???????????е?????
        }
        cBuilder.setWhen(System.currentTimeMillis());

        /*
         * ??AutoCancel???true?????????????notification?????????????????,
         * ????????????????????????????????????
         */
        cBuilder.setAutoCancel(true);
        // ??Ongoing???true ???notification????????????
        // notifyBuilder.setOngoing(true);
        /*
         * ??Android4.1???????????????·?????????notification?????????
         * ???????????????????????????????????????????????????????
         */
        cBuilder.setPriority(NotificationCompat.PRIORITY_MAX);
        /*
         * Notification.DEFAULT_ALL?????????????????????
         * Notification.DEFAULT_SOUND?????????????
         * Notification.DEFAULT_VIBRATE??????????
         * Notification.DEFAULT_LIGHTS???????????
         * notifyBuilder.setDefaults(Notification.DEFAULT_ALL);
         */
        cBuilder.setDefaults(Notification.DEFAULT_ALL);
    }

    /**
     * ????builder????????????????????????
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     */
    @TargetApi(Build.VERSION_CODES.JELLY_BEAN)
    private void setBuilder(Intent intent, int smallIcon, String ticker) {
        nBuilder = new Notification.Builder(mContext);
        // ??????Activity??????????????????Activity??
        intent.setFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);
        PendingIntent pIntent = PendingIntent.getActivity(mContext,
                requestCode, intent, FLAG);
        nBuilder.setContentIntent(pIntent);
        nBuilder.setSmallIcon(smallIcon);
        nBuilder.setTicker(ticker);
        nBuilder.setWhen(System.currentTimeMillis());
        nBuilder.setPriority(NotificationCompat.PRIORITY_MAX);
        nBuilder.setDefaults(Notification.DEFAULT_ALL);
    }

    /**
     * ???????
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     * @param title
     * @param msg
     */
    public void normal_notification(Intent intent, int smallIcon,
                                    String ticker, String title, String msg) {

        setCompatBuilder(intent, smallIcon, ticker, title, msg);
        sent();
    }

    /**
     * ???ж??????????(??С???????????????????????????????????)
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     * @param LargeIcon
     * @param title
     * @param msg
     */
    public void special_notification(Intent intent, int smallIcon,
                                     String ticker, int LargeIcon, String title, String msg) {

        setCompatBuilder(intent, smallIcon, ticker, title, msg);

        // ?????????LargeIcon??????????????????SmallIcon???????????????????????????????С??????????
        Bitmap bitmap = BitmapFactory.decodeResource(mContext.getResources(),
                LargeIcon);
        cBuilder.setLargeIcon(bitmap);

        // ??Ongoing???true ???notification????????????
        cBuilder.setOngoing(true);
        // ????
        Intent deleteIntent = new Intent(mContext, DeleteService.class);
        int deleteCode = (int) SystemClock.uptimeMillis();
        // ???????????????
        PendingIntent deletePendingIntent = PendingIntent.getService(mContext,
                deleteCode, deleteIntent, PendingIntent.FLAG_UPDATE_CURRENT);
        cBuilder.setDeleteIntent(deletePendingIntent);

        cBuilder.setDefaults(Notification.DEFAULT_SOUND | // ???????????????
                Notification.DEFAULT_LIGHTS);// ???????????LED
        cBuilder.setVibrate(new long[] { 0, 100, 200, 300 });// ????????????
        cBuilder.setAutoCancel(true);
        // builder.setSound(Uri.parse("file:///sdcard/click.mp3"));

        // ??????????????????,??????????????????????????????????????????????
        cBuilder.setNumber(3);
        cBuilder.setStyle(new NotificationCompat.InboxStyle()
                .addLine("M.Lynn ????????kale").addLine("M.Lynn ?????????????????")
                .addLine("M.Lynn ????????????~").setSummaryText("+3 more")); // ????????????????????????
        sent();
    }

    /**
     * ????????????
     *
     * @param remoteViews
     * @param intent
     * @param smallIcon
     * @param ticker
     */
    public void view_notification(RemoteViews remoteViews, Intent intent,
                                  int smallIcon, String ticker) {

        setCompatBuilder(intent, smallIcon, ticker, null, null);

        notification = cBuilder.build();
        notification.contentView = remoteViews;
        // ???????
        nm.notify(NOTIFICATION_ID, notification);
    }

    /**
     * ???????????????????????? (??????汾?????в???????????????ж?)
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     * @param title
     * @param msg
     */
    @TargetApi(Build.VERSION_CODES.JELLY_BEAN)
    public void big_notification(Intent intent, int smallIcon, String ticker,
                                 String title, String msg) {

        final int sdk = Build.VERSION.SDK_INT;
        if (sdk < Build.VERSION_CODES.JELLY_BEAN) {
            normal_notification(intent, smallIcon, ticker, title, msg);
        } else {
            setBuilder(intent, smallIcon, ticker);
            nBuilder.setContentTitle(title);
            nBuilder.setPriority(Notification.PRIORITY_HIGH);
            notification = new Notification.BigTextStyle(nBuilder).bigText(msg)
                    .build();
            // ???????
            nm.notify(NOTIFICATION_ID, notification);
        }
    }

    /**
     * ?н????????????????????????????????????
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     * @param title
     * @param msg
     */
    public void progress_notification(Intent intent, int smallIcon,
                                      String ticker, String title, String msg) {

        setCompatBuilder(intent, smallIcon, ticker, title, msg);
        /*
         * ???????????????????????????????????????????????????????????????
         * ??????????????????????????????????????????????ε?????????
         */

        new Thread(new Runnable() {
            @Override
            public void run() {
                int incr;
                for (incr = 0; incr <= 100; incr += 10) {
                    // ??????1.??????? 2.???????? 3.???????????????
                    cBuilder.setProgress(100, incr, false);
                    // cBuilder.setProgress(0, 0, true);
                    sent();
                    try {
                        Thread.sleep(1 * 500);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                // ???????????????????
                cBuilder.setContentText("???????~").setProgress(0, 0, false);
                sent();
            }
        }).start();
    }

    /**
     * ???????????
     *
     * @param intent
     * @param smallIcon
     * @param ticker
     * @param title
     * @param bigPic
     */
    public void pic_notification(Intent intent, int smallIcon, String ticker,
                                 String title, int bigPic) {

        setCompatBuilder(intent, smallIcon, ticker, title, null);
        NotificationCompat.BigPictureStyle picStyle = new NotificationCompat.BigPictureStyle();
        Bitmap bitmap = BitmapFactory.decodeResource(mContext.getResources(),
                bigPic);
        picStyle.bigPicture(bitmap);
        cBuilder.setStyle(picStyle);
        sent();
    }


    /**
     * ??????
     */
    private void sent() {
        notification = cBuilder.build();
        // ???????
        nm.notify(NOTIFICATION_ID, notification);
    }

    /**
     * ????id?????
     */
    public void clear() {
        // ?????
        nm.cancelAll();

    }

}
